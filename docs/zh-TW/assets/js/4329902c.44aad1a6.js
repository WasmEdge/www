"use strict";(self.webpackChunkbook=self.webpackChunkbook||[]).push([[5315],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>h});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),m=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=m(e.components);return a.createElement(s.Provider,{value:t},e.children)},u="mdxType",c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),u=m(n),d=r,h=u["".concat(s,".").concat(d)]||u[d]||c[d]||l;return n?a.createElement(h,o(o({ref:t},p),{},{components:n})):a.createElement(h,o({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,o=new Array(l);o[0]=d;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i[u]="string"==typeof e?e:r,o[1]=i;for(var m=2;m<l;m++)o[m]=n[m];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},85915:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>c,frontMatter:()=>l,metadata:()=>i,toc:()=>m});var a=n(87462),r=(n(67294),n(3905));const l={sidebar_position:1},o="Llama 2 inference",i={unversionedId:"develop/rust/wasinn/llm_inference",id:"develop/rust/wasinn/llm_inference",title:"Llama 2 inference",description:"WasmEdge now supports running llama2 series of models in Rust. We will use this example project to show how to make AI inferences with the llama2 model in WasmEdge and Rust.",source:"@site/docs/develop/rust/wasinn/llm_inference.md",sourceDirName:"develop/rust/wasinn",slug:"/develop/rust/wasinn/llm_inference",permalink:"/docs/zh-TW/develop/rust/wasinn/llm_inference",draft:!1,editUrl:"https://github.com/wasmedge/docs/blob/main/docs/develop/rust/wasinn/llm_inference.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"developSidebar",previous:{title:"AI inference",permalink:"/docs/zh-TW/category/ai-inference"},next:{title:"Mediapipe solutions",permalink:"/docs/zh-TW/develop/rust/wasinn/mediapipe"}},s={},m=[{value:"Prerequisite",id:"prerequisite",level:2},{value:"Quick start",id:"quick-start",level:2},{value:"Build and run",id:"build-and-run",level:2},{value:"Optional: Configure the model",id:"optional-configure-the-model",level:2},{value:"Improve performance",id:"improve-performance",level:2},{value:"Understand the code",id:"understand-the-code",level:2}],p={toc:m},u="wrapper";function c(e){let{components:t,...n}=e;return(0,r.kt)(u,(0,a.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"llama-2-inference"},"Llama 2 inference"),(0,r.kt)("p",null,"WasmEdge now supports running llama2 series of models in Rust. We will use ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/llama-utils/tree/main/chat"},"this example project")," to show how to make AI inferences with the llama2 model in WasmEdge and Rust."),(0,r.kt)("p",null,"WasmEdge now supports Llama2, Codellama-instruct, BELLE-Llama, Mistral-7b-instruct, Wizard-vicuna, OpenChat 3.5B and raguile-chatml. "),(0,r.kt)("h2",{id:"prerequisite"},"Prerequisite"),(0,r.kt)("p",null,"Besides the ",(0,r.kt)("a",{parentName:"p",href:"/docs/zh-TW/develop/rust/setup"},"regular WasmEdge and Rust requirements"),", please make sure that you have the ",(0,r.kt)("a",{parentName:"p",href:"/docs/zh-TW/start/install#wasi-nn-plug-in-with-ggml-backend"},"Wasi-NN plugin with ggml installed"),"."),(0,r.kt)("h2",{id:"quick-start"},"Quick start"),(0,r.kt)("p",null,"Because the example already includes a compiled WASM file from the Rust code, we could use WasmEdge CLI to execute the example directly. First, git clone the ",(0,r.kt)("inlineCode",{parentName:"p"},"llama-utils")," repo."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/second-state/llama-utils.git\ncd chat\n")),(0,r.kt)("p",null,"Next, let's get the model. In this example, we are going to use the llama2 7b chat model in GGUF format. You can also use other kinds of llama2 models, check out ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/llama-utils/blob/main/chat/README.md#get-model"},"here"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"git clone curl -LO https://huggingface.co/wasmedge/llama2/blob/main/llama-2-7b-chat-q5_k_m.gguf\n")),(0,r.kt)("p",null,"Run the inference application in WasmEdge."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"wasmedge --dir .:. \\\n  --nn-preload default:GGML:CPU:llama-2-7b.Q5_K_M.gguf llama-chat.wasm default \\\n  --prompt 'Robert Oppenheimer most important achievement is ' \\\n  --ctx-size 4096\n")),(0,r.kt)("p",null,"After executing the command, you may need to wait a moment for the input prompt to appear. Once the execution is complete, the following output will be generated."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"Robert Oppenheimer most important achievement is\n1945 Manhattan Project.\nRobert Oppenheimer was born in New York City on April 22, 1904. He was the son of Julius Oppenheimer, a wealthy German-Jewish textile merchant, and Ella Friedman Oppenheimer.\nRobert Oppenheimer was a brilliant student. He attended the Ethical Culture School in New York City and graduated from the Ethical Culture Fieldston School in 1921. He then attended Harvard University, where he received his bachelor's degree.\n")),(0,r.kt)("h2",{id:"build-and-run"},"Build and run"),(0,r.kt)("p",null,"Let's build the wasm file from the rust source code. First, git clone the ",(0,r.kt)("inlineCode",{parentName:"p"},"llama-utils")," repo."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"git clone https://github.com/second-state/llama-utils.git\ncd chat\n")),(0,r.kt)("p",null,"Second, use ",(0,r.kt)("inlineCode",{parentName:"p"},"cargo")," to build the example project."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cargo build --target wasm32-wasi --release\n")),(0,r.kt)("p",null,"The output WASM file is ",(0,r.kt)("inlineCode",{parentName:"p"},"target/wasm32-wasi/release/llama-chat.wasm"),". "),(0,r.kt)("p",null,"We also need to get the model. Here we use the llama-2-13b model."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -LO https://huggingface.co/wasmedge/llama2/blob/main/llama-2-13b-q5_k_m.gguf\n")),(0,r.kt)("p",null,"Next, use WasmEdge to load the llama-2-13b model and then ask the model to questions."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"wasmedge --dir .:. \\\n  --nn-preload default:GGML:CPU:llama-2-13b.Q5_K_M.gguf llama-chat.wasm default \\\n  --prompt 'Robert Oppenheimer most important achievement is ' \\\n  --ctx-size 4096\n")),(0,r.kt)("p",null,"After executing the command, you may need to wait a moment for the input prompt to appear. You can enter your question once you see the ",(0,r.kt)("inlineCode",{parentName:"p"},"[USER]:")," prompt:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"Robert Oppenheimer most important achievement is\n1945 Manhattan Project.\nRobert Oppenheimer was born in New York City on April 22, 1904. He was the son of Julius Oppenheimer, a wealthy German-Jewish textile merchant, and Ella Friedman Oppenheimer.\nRobert Oppenheimer was a brilliant student. He attended the Ethical Culture School in New York City and graduated from the Ethical Culture Fieldston School in 1921. He then attended Harvard University, where he received his bachelor's degree\n")),(0,r.kt)("h2",{id:"optional-configure-the-model"},"Optional: Configure the model"),(0,r.kt)("p",null,"You can use environment variables to configure the model execution."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Option"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"),(0,r.kt)("th",{parentName:"tr",align:null},"Function"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"LLAMA_LOG"),(0,r.kt)("td",{parentName:"tr",align:null},"0"),(0,r.kt)("td",{parentName:"tr",align:null},"The backend will print diagnostic information when this value is set to 1")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"LLAMA_N_CTX"),(0,r.kt)("td",{parentName:"tr",align:null},"512"),(0,r.kt)("td",{parentName:"tr",align:null},"The context length is the max number of tokens in the entire conversation")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"LLAMA_N_PREDICT"),(0,r.kt)("td",{parentName:"tr",align:null},"512"),(0,r.kt)("td",{parentName:"tr",align:null},"The number of tokens to generate in each response from the model")))),(0,r.kt)("p",null,"For example, the following command specifies a context length of 4k tokens, which is standard for llama2, and the max number of tokens in each response to be 1k. It also tells WasmEdge to print out logs and statistics of the model at runtime."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"LLAMA_LOG=1 LLAMA_N_CTX=4096 LLAMA_N_PREDICT=128 wasmedge --dir .:. \\\n  --nn-preload default:GGML:CPU:llama-2-7b.Q5_K_M.gguf llama-simple.wasm default \\\n  --prompt 'Robert Oppenheimer most important achievement is ' \\\n  --ctx-size 4096\n\n...................................................................................................\n[2023-10-08 23:13:10.272] [info] [WASI-NN] GGML backend: set n_ctx to 4096\nllama_new_context_with_model: kv self size  = 2048.00 MB\nllama_new_context_with_model: compute buffer total size =  297.47 MB\nllama_new_context_with_model: max tensor size =   102.54 MB\n[2023-10-08 23:13:10.472] [info] [WASI-NN] GGML backend: llama_system_info: AVX = 0 | AVX2 = 0 | AVX512 = 0 | AVX512_VBMI = 0 | AVX512_VNNI = 0 | FMA = 0 | NEON = 1 | ARM_FMA = 1 | F16C = 0 | FP16_VA = 1 | WASM_SIMD = 0 | BLAS = 0 | SSE3 = 0 | SSSE3 = 0 | VSX = 0 |\n[2023-10-08 23:13:10.472] [info] [WASI-NN] GGML backend: set n_predict to 128\n[2023-10-08 23:13:16.014] [info] [WASI-NN] GGML backend: llama_get_kv_cache_token_count 128\n\nllama_print_timings:        load time =  1431.58 ms\nllama_print_timings:      sample time =     3.53 ms /   118 runs   (    0.03 ms per token, 33446.71 tokens per second)\nllama_print_timings: prompt eval time =  1230.69 ms /    11 tokens (  111.88 ms per token,     8.94 tokens per second)\nllama_print_timings:        eval time =  4295.81 ms /   117 runs   (   36.72 ms per token,    27.24 tokens per second)\nllama_print_timings:       total time =  5742.71 ms\nRobert Oppenheimer most important achievement is\n1945 Manhattan Project.\nRobert Oppenheimer was born in New York City on April 22, 1904. He was the son of Julius Oppenheimer, a wealthy German-Jewish textile merchant, and Ella Friedman Oppenheimer.\nRobert Oppenheimer was a brilliant student. He attended the Ethical Culture School in New York City and graduated from the Ethical Culture Fieldston School in 1921. He then attended Harvard University, where he received his bachelor's degree.\n")),(0,r.kt)("h2",{id:"improve-performance"},"Improve performance"),(0,r.kt)("p",null,"You can make the inference program run faster by AOT compiling the wasm file first."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"wasmedge compile llama-chat.wasm llama-chat.wasm\nwasmedge --dir .:. \\\n  --nn-preload default:GGML:CPU:llama-2-13b-q5_k_m.gguf \\\n  llama-chat.wasm --model-alias default --prompt-template llama-2-chat\n")),(0,r.kt)("h2",{id:"understand-the-code"},"Understand the code"),(0,r.kt)("p",null,"The ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/llama-utils/blob/main/chat/src/main.rs"},"main.rs")," is the full Rust code to create an interactive chatbot using a LLM. The Rust program manages the user input, tracks the conversation history, transforms the text into the llama2 and other model\u2019s chat templates, and runs the inference operations using the WASI NN standard API."),(0,r.kt)("p",null,"First, let's parse command line arguments to customize the chatbot's behavior using ",(0,r.kt)("inlineCode",{parentName:"p"},"Command")," struct. It extracts the following parameters: ",(0,r.kt)("inlineCode",{parentName:"p"},"prompt")," (a prompt that guides the conversation), ",(0,r.kt)("inlineCode",{parentName:"p"},"model_alias")," (a list for the loaded model), and ",(0,r.kt)("inlineCode",{parentName:"p"},"ctx_size")," (the size of the chat context). "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'fn main() -> Result<(), String> {\n    let matches = Command::new("Llama API Server")\n        .arg(\n            Arg::new("prompt")\n                .short(\'p\')\n                .long("prompt")\n                .value_name("PROMPT")\n                .help("Sets the prompt.")\n                .required(true),\n        )\n        .arg(\n            Arg::new("model_alias")\n                .short(\'m\')\n                .long("model-alias")\n                .value_name("ALIAS")\n                .help("Sets the model alias")\n                .default_value("default"),\n        )\n        .arg(\n            Arg::new("ctx_size")\n                .short(\'c\')\n                .long("ctx-size")\n                .value_parser(clap::value_parser!(u32))\n                .value_name("CTX_SIZE")\n                .help("Sets the prompt context size")\n                .default_value(DEFAULT_CTX_SIZE),\n        )\n        .get_matches();\n\n    // model alias\n    let model_name = matches\n        .get_one::<String>("model_alias")\n        .unwrap()\n        .to_string();\n\n    // prompt context size\n    let ctx_size = matches.get_one::<u32>("ctx_size").unwrap();\n    CTX_SIZE\n        .set(*ctx_size as usize)\n        .expect("Fail to parse prompt context size");\n\n    // prompt\n    let prompt = matches.get_one::<String>("prompt").unwrap().to_string();\n')),(0,r.kt)("p",null,"After that, the program will create a new Graph using the ",(0,r.kt)("inlineCode",{parentName:"p"},"GraphBuilder")," and loads the model specified by the ",(0,r.kt)("inlineCode",{parentName:"p"},"model_name")," ."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'// load the model to wasi-nn\n     let graph =\n        wasi_nn::GraphBuilder::new(wasi_nn::GraphEncoding::Ggml, wasi_nn::ExecutionTarget::AUTO)\n            .build_from_cache(&model_name)\n            .expect("Failed to load the model");\n')),(0,r.kt)("p",null,"Next, We create an execution context from the loaded Graph. The context is mutable because we will be changing it when we set the input tensor and execute the inference."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},' // initialize the execution context\n    let mut context = graph\n        .init_execution_context()\n        .expect("Failed to init context");\n')),(0,r.kt)("p",null,"Next, The prompt is converted into bytes and set as the input tensor for the model inference."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},' // set input tensor\n    let tensor_data = prompt.as_str().as_bytes().to_vec();\n    context\n        .set_input(0, wasi_nn::TensorType::U8, &[1], &tensor_data)\n        .expect("Failed to set prompt as the input tensor");\n')),(0,r.kt)("p",null,"Next, excute the model inference."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'  // execute the inference\n    context.compute().expect("Failed to complete inference");\n')),(0,r.kt)("p",null,"After the inference is fiished, extract the result from the computation context and losing invalid UTF8 sequences handled by converting the output to a string using ",(0,r.kt)("inlineCode",{parentName:"p"},"String::from_utf8_lossy"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'  let mut output_buffer = vec![0u8; *CTX_SIZE.get().unwrap()];\n    let mut output_size = context\n        .get_output(0, &mut output_buffer)\n        .expect("Failed to get output tensor");\n    output_size = std::cmp::min(*CTX_SIZE.get().unwrap(), output_size);\n    let output = String::from_utf8_lossy(&output_buffer[..output_size]).to_string();\n')),(0,r.kt)("p",null,"Finally, print the prompt and the inference output to the console."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'println!("\\nprompt: {}", &prompt);\nprintln!("\\noutput: {}", output);\n')),(0,r.kt)("p",null,"The code explanation above is simple one time chat with llama 2 model. But we have more!"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"If you're looking for continuous conversations with llama 2 models, please check out the source code ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/second-state/llama-utils/tree/main/chat"},"here"),"."),(0,r.kt)("li",{parentName:"ul"},"If you want to construct OpenAI-compatible APIs specifically for your llama2 model, or the Llama2 model itself, please check out the surce code ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/second-state/llama-utils/tree/main/api-server"},"here"),"."),(0,r.kt)("li",{parentName:"ul"},"For the reason why we need to run LLama2 model with WasmEdge, please check out ",(0,r.kt)("a",{parentName:"li",href:"https://medium.com/stackademic/fast-and-portable-llama2-inference-on-the-heterogeneous-edge-a62508e82359"},"this article"),".")))}c.isMDXComponent=!0}}]);