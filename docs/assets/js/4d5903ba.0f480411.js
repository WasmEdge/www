"use strict";(self.webpackChunkbook=self.webpackChunkbook||[]).push([[6423],{3905:(e,t,a)=>{a.d(t,{Zo:()=>m,kt:()=>h});var n=a(67294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var p=n.createContext({}),s=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},m=function(e){var t=s(e.components);return n.createElement(p.Provider,{value:t},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,l=e.originalType,p=e.parentName,m=o(e,["components","mdxType","originalType","parentName"]),u=s(a),c=i,h=u["".concat(p,".").concat(c)]||u[c]||d[c]||l;return a?n.createElement(h,r(r({ref:t},m),{},{components:a})):n.createElement(h,r({ref:t},m))}));function h(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var l=a.length,r=new Array(l);r[0]=c;var o={};for(var p in t)hasOwnProperty.call(t,p)&&(o[p]=t[p]);o.originalType=e,o[u]="string"==typeof e?e:i,r[1]=o;for(var s=2;s<l;s++)r[s]=a[s];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},26281:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>r,default:()=>d,frontMatter:()=>l,metadata:()=>o,toc:()=>s});var n=a(87462),i=(a(67294),a(3905));const l={sidebar_position:3},r="The AoT Compiler",o={unversionedId:"start/build-and-run/aot",id:"start/build-and-run/aot",title:"The AoT Compiler",description:"After installation, users can execute the wasmedge compile command.",source:"@site/docs/start/build-and-run/aot.md",sourceDirName:"start/build-and-run",slug:"/start/build-and-run/aot",permalink:"/docs/start/build-and-run/aot",draft:!1,editUrl:"https://github.com/wasmedge/docs/blob/main/docs/start/build-and-run/aot.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"startSidebar",previous:{title:"wasmedge run CLI",permalink:"/docs/start/build-and-run/run"},next:{title:"Docker + WASM",permalink:"/docs/start/build-and-run/docker_wasm"}},p={},s=[{value:"Options",id:"options",level:2},{value:"Example",id:"example",level:2},{value:"Output Format: Universal WASM",id:"output-format-universal-wasm",level:2},{value:"Output Format: Shared Library",id:"output-format-shared-library",level:2}],m={toc:s},u="wrapper";function d(e){let{components:t,...a}=e;return(0,i.kt)(u,(0,n.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"the-aot-compiler"},"The AoT Compiler"),(0,i.kt)("p",null,"After ",(0,i.kt)("a",{parentName:"p",href:"/docs/start/install#install"},"installation"),", users can execute the ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmedge compile")," command."),(0,i.kt)("p",null,"The usage of the ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmedge compile")," command will be:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"$ wasmedge compile -h\nUSAGE\n   wasmedge compile [OPTIONS] [--] WASM WASM_SO\n\n...\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmedge compile")," command can compile WebAssembly into native machine code (i.e., the AOT compiler). For the pure WebAssembly, the ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmedge")," tool will execute the WASM in interpreter mode. After compiling with the ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmedge compile")," AOT compiler, the ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmedge")," tool can execute the WASM in AOT mode, which is much faster."),(0,i.kt)("h2",{id:"options"},"Options"),(0,i.kt)("p",null,"The options of the ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmedge compile")," command are as follows."),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("inlineCode",{parentName:"li"},"-h|--help"),": Show the help messages. Will ignore the other arguments below."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("em",{parentName:"li"},"(Optional)")," ",(0,i.kt)("inlineCode",{parentName:"li"},"--dump"),": Dump the LLVM IR to ",(0,i.kt)("inlineCode",{parentName:"li"},"wasm.ll")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"wasm-opt.ll"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("em",{parentName:"li"},"(Optional)")," ",(0,i.kt)("inlineCode",{parentName:"li"},"--interruptible"),": Generate the binary which supports interruptible execution.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"By default, the AOT-compiled WASM not supports ",(0,i.kt)("a",{parentName:"li",href:"../../embed/c/reference/0.12.x#async"},"interruptions in asynchronous executions"),"."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("em",{parentName:"li"},"(Optional)")," Statistics information:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"By default, the AOT-compiled WASM not supports all statistics even if the options are turned on when running the ",(0,i.kt)("inlineCode",{parentName:"li"},"wasmedge")," tool."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--enable-time-measuring")," to generate code for enabling time-measuring statistics in execution."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--enable-gas-measuring")," to generate code for enabling the statistics of gas measuring in execution."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--enable-instruction-count")," to generate code for enabling the statistics of counting WebAssembly instructions."),(0,i.kt)("li",{parentName:"ul"},"Or use ",(0,i.kt)("inlineCode",{parentName:"li"},"--enable-all-statistics")," to generate code for enabling all of the statistics."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("em",{parentName:"li"},"(Optional)")," ",(0,i.kt)("inlineCode",{parentName:"li"},"--generic-binary"),": Generate the generic binary of the current host CPU architecture."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("em",{parentName:"li"},"(Optional)")," WebAssembly proposals:",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--disable-import-export-mut-globals")," to disable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/WebAssembly/mutable-global"},"Import/Export of Mutable Globals")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"ON"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--disable-non-trap-float-to-int")," to disable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/WebAssembly/nontrapping-float-to-int-conversions"},"Non-Trapping Float-to-Int Conversions")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"ON"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--disable-sign-extension-operators")," to disable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/WebAssembly/sign-extension-ops"},"Sign-Extension Operators")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"ON"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--disable-multi-value")," to disable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/WebAssembly/multi-value"},"Multi-value")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"ON"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--disable-bulk-memory")," to disable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/WebAssembly/bulk-memory-operations"},"Bulk Memory Operations")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"ON"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--disable-reference-types")," to disable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/WebAssembly/reference-types"},"Reference Types")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"ON"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--disable-simd")," to disable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/webassembly/simd"},"Fixed-width SIMD")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"ON"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--enable-multi-memory")," to enable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/WebAssembly/multi-memory"},"Multiple Memories")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"OFF"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--enable-tail-call")," to enable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/WebAssembly/tail-call"},"Tail call")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"OFF"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--enable-extended-const")," to enable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/WebAssembly/extended-const"},"Extended Constant Expressions")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"OFF"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--enable-threads")," to enable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/webassembly/threads"},"Threads")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"OFF"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--enable-function-reference")," to enable the ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/WebAssembly/function-references"},"Typed-Function References")," proposal (Default ",(0,i.kt)("inlineCode",{parentName:"li"},"OFF"),")."),(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--enable-all")," to enable ALL proposals above."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("em",{parentName:"li"},"(Optional)")," ",(0,i.kt)("inlineCode",{parentName:"li"},"--optimize"),": Select the LLVM optimization level.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"Use ",(0,i.kt)("inlineCode",{parentName:"li"},"--optimize LEVEL")," to set the optimization level. The ",(0,i.kt)("inlineCode",{parentName:"li"},"LEVEL")," should be one of ",(0,i.kt)("inlineCode",{parentName:"li"},"0"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"1"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"2"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"3"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"s"),", or ",(0,i.kt)("inlineCode",{parentName:"li"},"z"),"."),(0,i.kt)("li",{parentName:"ul"},"The default value will be ",(0,i.kt)("inlineCode",{parentName:"li"},"2"),", which means ",(0,i.kt)("inlineCode",{parentName:"li"},"O2"),"."))),(0,i.kt)("li",{parentName:"ol"},"Input WASM file (",(0,i.kt)("inlineCode",{parentName:"li"},"/path/to/wasm/file"),")."),(0,i.kt)("li",{parentName:"ol"},"Output path (",(0,i.kt)("inlineCode",{parentName:"li"},"/path/to/output/file"),").",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"By default, the ",(0,i.kt)("inlineCode",{parentName:"li"},"wasmedge compile")," command will output the ",(0,i.kt)("a",{parentName:"li",href:"#output-format-universal-wasm"},"universal WASM format"),"."),(0,i.kt)("li",{parentName:"ul"},"If the specific file extension (",(0,i.kt)("inlineCode",{parentName:"li"},".so")," on Linux, ",(0,i.kt)("inlineCode",{parentName:"li"},".dylib")," on MacOS, and ",(0,i.kt)("inlineCode",{parentName:"li"},".dll")," on Windows) is assigned in the output path, the ",(0,i.kt)("inlineCode",{parentName:"li"},"wasmedge compile")," command will output the ",(0,i.kt)("a",{parentName:"li",href:"#output-format-shared-library"},"shared library format"),".")))),(0,i.kt)("h2",{id:"example"},"Example"),(0,i.kt)("p",null,"We created the hand-written ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/WasmEdge/WasmEdge/raw/master/examples/wasm/fibonacci.wat"},"fibonacci.wat")," and used the ",(0,i.kt)("a",{parentName:"p",href:"https://webassembly.github.io/wabt/demo/wat2wasm/"},"wat2wasm")," tool to convert it into the ",(0,i.kt)("inlineCode",{parentName:"p"},"fibonacci.wasm")," WebAssembly program. Take it, for example. It exported a ",(0,i.kt)("inlineCode",{parentName:"p"},"fib()")," function, which takes a single ",(0,i.kt)("inlineCode",{parentName:"p"},"i32")," integer as the input parameter."),(0,i.kt)("p",null,"You can run:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"wasmedge compile fibonacci.wasm fibonacci_aot.wasm\n")),(0,i.kt)("p",null,"or:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"wasmedge compile fibonacci.wasm fibonacci_aot.so # On Linux.\n")),(0,i.kt)("p",null,"The output will be:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"[2022-09-09 14:22:10.540] [info] compile start\n[2022-09-09 14:22:10.541] [info] verify start\n[2022-09-09 14:22:10.542] [info] optimize start\n[2022-09-09 14:22:10.547] [info] codegen start\n[2022-09-09 14:22:10.552] [info] output start\n[2022-09-09 14:22:10.600] [info] compile done\n")),(0,i.kt)("p",null,"Then you can execute the output file with ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmedge")," and measure the execution time:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"time wasmedge --reactor fibonacci_aot.wasm fib 30\n")),(0,i.kt)("p",null,"The output will be:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"1346269\n\nreal    0m0.029s\nuser    0m0.012s\nsys     0m0.014s\n")),(0,i.kt)("p",null,"Then you can compare it with the interpreter mode:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"time wasmedge --reactor fibonacci.wasm fib 30\n")),(0,i.kt)("p",null,"The output shows that the AOT-compiled WASM is much faster than the interpreter mode:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"1346269\n\nreal    0m0.442s\nuser    0m0.427s\nsys     0m0.012s\n")),(0,i.kt)("h2",{id:"output-format-universal-wasm"},"Output Format: Universal WASM"),(0,i.kt)("p",null,"By default, the ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmedge compile")," AOT compiler tool could wrap the AOT-compiled native binary into a custom section in the origin WASM file. We call this the universal WASM binary format."),(0,i.kt)("p",null,"This AOT-compiled WASM file is compatible with any WebAssembly runtime. However, when this WASM file is executed by the WasmEdge runtime, WasmEdge will extract the native binary from the custom section and execute it in AOT mode."),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"On MacOS platforms, the universal WASM format will ",(0,i.kt)("inlineCode",{parentName:"p"},"bus error")," in execution. By default, the ",(0,i.kt)("inlineCode",{parentName:"p"},"wasmedge compile")," tool optimizes the WASM in the ",(0,i.kt)("inlineCode",{parentName:"p"},"O2")," level. We are trying to fix this issue. For working around, please use the shared library output format instead.")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"wasmedge compile app.wasm app_aot.wasm\nwasmedge app_aot.wasm\n")),(0,i.kt)("h2",{id:"output-format-shared-library"},"Output Format: Shared Library"),(0,i.kt)("p",null,"Users can assign the shared library extension for the output files (",(0,i.kt)("inlineCode",{parentName:"p"},".so")," on Linux, ",(0,i.kt)("inlineCode",{parentName:"p"},".dylib")," on MacOS, and ",(0,i.kt)("inlineCode",{parentName:"p"},".dll")," on Windows) to generate the shared library output format output."),(0,i.kt)("p",null,"This AOT-compiled WASM file is only for WasmEdge use and cannot be used by other WebAssembly runtimes."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"wasmedge compile app.wasm app_aot.so\nwasmedge app_aot.so\n")))}d.isMDXComponent=!0}}]);