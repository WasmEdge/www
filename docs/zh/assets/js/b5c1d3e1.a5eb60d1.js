"use strict";(self.webpackChunkbook=self.webpackChunkbook||[]).push([[9860],{3905:(e,a,t)=>{t.d(a,{Zo:()=>p,kt:()=>b});var n=t(67294);function r(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function s(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function l(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?s(Object(t),!0).forEach((function(a){r(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function o(e,a){if(null==e)return{};var t,n,r=function(e,a){if(null==e)return{};var t,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||(r[t]=e[t]);return r}(e,a);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)t=s[n],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var i=n.createContext({}),m=function(e){var a=n.useContext(i),t=a;return e&&(t="function"==typeof e?e(a):l(l({},a),e)),t},p=function(e){var a=m(e.components);return n.createElement(i.Provider,{value:a},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var a=e.children;return n.createElement(n.Fragment,{},a)}},c=n.forwardRef((function(e,a){var t=e.components,r=e.mdxType,s=e.originalType,i=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),d=m(t),c=r,b=d["".concat(i,".").concat(c)]||d[c]||u[c]||s;return t?n.createElement(b,l(l({ref:a},p),{},{components:t})):n.createElement(b,l({ref:a},p))}));function b(e,a){var t=arguments,r=a&&a.mdxType;if("string"==typeof e||r){var s=t.length,l=new Array(s);l[0]=c;var o={};for(var i in a)hasOwnProperty.call(a,i)&&(o[i]=a[i]);o.originalType=e,o[d]="string"==typeof e?e:r,l[1]=o;for(var m=2;m<s;m++)l[m]=t[m];return n.createElement.apply(null,l)}return n.createElement.apply(null,t)}c.displayName="MDXCreateElement"},74433:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>i,contentTitle:()=>l,default:()=>u,frontMatter:()=>s,metadata:()=>o,toc:()=>m});var n=t(87462),r=(t(67294),t(3905));const s={sidebar_position:1},l="\u5728 AWS Lambda \u4e2d\u4f7f\u7528 WebAssembly Serverless Functions",o={unversionedId:"start/usage/serverless/aws",id:"start/usage/serverless/aws",title:"\u5728 AWS Lambda \u4e2d\u4f7f\u7528 WebAssembly Serverless Functions",description:"\u5728\u672c\u6587\u4e2d\uff0c\u6211\u4eec\u5c06\u5c55\u793a\u5728 AWS Lambda \u4e0a\u90e8\u7f72\u7684\u4e24\u4e2a\u4f7f\u7528 Rust \u548c WasmEdge \u7f16\u5199\u7684\u65e0\u670d\u52a1\u5668\u51fd\u6570\u3002\u4e00\u4e2a\u662f\u56fe\u50cf\u5904\u7406\u51fd\u6570\uff0c\u53e6\u4e00\u4e2a\u662f TensorFlow \u63a8\u7406\u51fd\u6570\u3002",source:"@site/i18n/zh/docusaurus-plugin-content-docs/current/start/usage/serverless/aws.md",sourceDirName:"start/usage/serverless",slug:"/start/usage/serverless/aws",permalink:"/docs/zh/start/usage/serverless/aws",draft:!1,editUrl:"https://github.com/wasmedge/docs/blob/main/docs/start/usage/serverless/aws.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"startSidebar",previous:{title:"Serverless Platforms",permalink:"/docs/zh/category/serverless-platforms"},next:{title:"\u5728 Netlify \u4e0a\u7684 WebAssembly \u65e0\u670d\u52a1\u5668\u51fd\u6570",permalink:"/docs/zh/start/usage/serverless/netlify"}},i={},m=[{value:"\u73af\u5883",id:"\u73af\u5883",level:2},{value:"\u793a\u4f8b1\uff1a\u56fe\u50cf\u5904\u7406",id:"\u793a\u4f8b1\u56fe\u50cf\u5904\u7406",level:2},{value:"\u521b\u5efa\u51fd\u6570",id:"\u521b\u5efa\u51fd\u6570",level:3},{value:"\u521b\u5efa\u670d\u52a1\u811a\u672c\u4ee5\u52a0\u8f7d\u51fd\u6570",id:"\u521b\u5efa\u670d\u52a1\u811a\u672c\u4ee5\u52a0\u8f7d\u51fd\u6570",level:3},{value:"\u6784\u5efa\u7528\u4e8e Lambda \u90e8\u7f72\u7684 Docker \u955c\u50cf",id:"\u6784\u5efa\u7528\u4e8e-lambda-\u90e8\u7f72\u7684-docker-\u955c\u50cf",level:3},{value:"\u53ef\u9009\uff1a\u672c\u5730\u6d4b\u8bd5 Docker \u955c\u50cf",id:"\u53ef\u9009\u672c\u5730\u6d4b\u8bd5-docker-\u955c\u50cf",level:3},{value:"\u793a\u4f8b 2\uff1aAI \u63a8\u7406",id:"\u793a\u4f8b-2ai-\u63a8\u7406",level:2}],p={toc:m},d="wrapper";function u(e){let{components:a,...t}=e;return(0,r.kt)(d,(0,n.Z)({},p,t,{components:a,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"\u5728-aws-lambda-\u4e2d\u4f7f\u7528-webassembly-serverless-functions"},"\u5728 AWS Lambda \u4e2d\u4f7f\u7528 WebAssembly Serverless Functions"),(0,r.kt)("p",null,"\u5728\u672c\u6587\u4e2d\uff0c\u6211\u4eec\u5c06\u5c55\u793a\u5728 AWS Lambda \u4e0a\u90e8\u7f72\u7684\u4e24\u4e2a\u4f7f\u7528 Rust \u548c WasmEdge \u7f16\u5199\u7684\u65e0\u670d\u52a1\u5668\u51fd\u6570\u3002\u4e00\u4e2a\u662f\u56fe\u50cf\u5904\u7406\u51fd\u6570\uff0c\u53e6\u4e00\u4e2a\u662f TensorFlow \u63a8\u7406\u51fd\u6570\u3002"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u60f3\u4e86\u89e3\u4e3a\u4ec0\u4e48\u8981\u5728 AWS Lambda \u4e0a\u4f7f\u7528 WasmEdge\uff0c\u8bf7\u53c2\u9605\u6587\u7ae0 ",(0,r.kt)("a",{parentName:"p",href:"https://www.secondstate.io/articles/webassembly-serverless-functions-in-aws-lambda/"},"WebAssembly Serverless Functions in AWS Lambda"),"\u3002")),(0,r.kt)("h2",{id:"\u73af\u5883"},"\u73af\u5883"),(0,r.kt)("p",null,"\u7531\u4e8e\u6211\u4eec\u7684\u6f14\u793a WebAssembly \u51fd\u6570\u662f\u7528 Rust \u7f16\u5199\u7684\uff0c\u4f60\u9700\u8981\u5b89\u88c5 ",(0,r.kt)("a",{parentName:"p",href:"https://www.rust-lang.org/tools/install"},"Rust \u7f16\u8bd1\u5668"),"\u3002\u786e\u4fdd\u4f60\u6309\u7167\u4ee5\u4e0b\u65b9\u5f0f\u5b89\u88c5 ",(0,r.kt)("inlineCode",{parentName:"p"},"wasm32-wasip1")," \u7f16\u8bd1\u76ee\u6807\uff0c\u4ee5\u751f\u6210 WebAssembly \u5b57\u8282\u7801\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"rustup target add wasm32-wasip1\n")),(0,r.kt)("p",null,"\u6f14\u793a\u5e94\u7528\u7684\u524d\u7aef\u662f\u7528 ",(0,r.kt)("a",{parentName:"p",href:"https://nextjs.org/"},"Next.js")," \u7f16\u5199\u7684\uff0c\u5e76\u90e8\u7f72\u5728 AWS Lambda \u4e0a\u3002\u6211\u4eec\u5047\u8bbe\u4f60\u5df2\u7ecf\u5bf9\u5982\u4f55\u4f7f\u7528 Next.js \u548c Lambda \u6709\u57fa\u672c\u7684\u4e86\u89e3\u3002"),(0,r.kt)("h2",{id:"\u793a\u4f8b1\u56fe\u50cf\u5904\u7406"},"\u793a\u4f8b1\uff1a\u56fe\u50cf\u5904\u7406"),(0,r.kt)("p",null,"\u6211\u4eec\u7684\u7b2c\u4e00\u4e2a\u6f14\u793a\u5e94\u7528\u5141\u8bb8\u7528\u6237\u4e0a\u4f20\u56fe\u50cf\uff0c\u7136\u540e\u8c03\u7528\u4e00\u4e2a\u65e0\u670d\u52a1\u5668\u51fd\u6570\u5c06\u5176\u8f6c\u6362\u4e3a\u9ed1\u767d\u56fe\u50cf\u3002\u901a\u8fc7 GitHub Pages \u90e8\u7f72\u4e86\u4e00\u4e2a",(0,r.kt)("a",{parentName:"p",href:"https://second-state.github.io/aws-lambda-wasm-runtime/"},"\u5b9e\u65f6\u6f14\u793a"),"\u3002"),(0,r.kt)("p",null,"\u9996\u5148 Fork ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime"},"demo \u5e94\u7528\u7684 GitHub \u5b58\u50a8\u5e93"),"\u3002\u8981\u5728 AWS Lambda \u4e0a\u90e8\u7f72\u5e94\u7528\u7a0b\u5e8f\uff0c\u8bf7\u6309\u7167\u5b58\u50a8\u5e93 ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/blob/tensorflow/README.md"},"README"),"\u4e2d\u7684\u6307\u5357\u8fdb\u884c\u64cd\u4f5c\u3002"),(0,r.kt)("h3",{id:"\u521b\u5efa\u51fd\u6570"},"\u521b\u5efa\u51fd\u6570"),(0,r.kt)("p",null,"\u6b64\u5b58\u50a8\u5e93\u662f\u4e00\u4e2a\u6807\u51c6\u7684 Next.js \u5e94\u7528\u7a0b\u5e8f\u3002\u540e\u7aef\u65e0\u670d\u52a1\u5668\u51fd\u6570\u4f4d\u4e8e ",(0,r.kt)("inlineCode",{parentName:"p"},"api/functions/image_grayscale")," \u6587\u4ef6\u5939\u4e2d\u3002",(0,r.kt)("inlineCode",{parentName:"p"},"src/main.rs")," \u6587\u4ef6\u5305\u542b\u4e86 Rust \u7a0b\u5e8f\u7684\u6e90\u4ee3\u7801\u3002Rust \u7a0b\u5e8f\u4ece ",(0,r.kt)("inlineCode",{parentName:"p"},"STDIN")," \u8bfb\u53d6\u56fe\u50cf\u6570\u636e\uff0c\u7136\u540e\u5c06\u9ed1\u767d\u56fe\u50cf\u8f93\u51fa\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"STDOUT"),"\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"use hex;\nuse std::io::{self, Read};\nuse image::{ImageOutputFormat, ImageFormat};\n\nfn main() {\n  let mut buf = Vec::new();\n  io::stdin().read_to_end(&mut buf).unwrap();\n\n  let image_format_detected: ImageFormat = image::guess_format(&buf).unwrap();\n  let img = image::load_from_memory(&buf).unwrap();\n  let filtered = img.grayscale();\n  let mut buf = vec![];\n  match image_format_detected {\n    ImageFormat::Gif => {\n      filtered.write_to(&mut buf, ImageOutputFormat::Gif).unwrap();\n    },\n    _ => {\n      filtered.write_to(&mut buf, ImageOutputFormat::Png).unwrap();\n    },\n  };\n  io::stdout().write_all(&buf).unwrap();\n  io::stdout().flush().unwrap();\n}\n")),(0,r.kt)("p",null,"\u4f60\u53ef\u4ee5\u4f7f\u7528 Rust \u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"cargo")," \u5de5\u5177\u5c06 Rust \u7a0b\u5e8f\u6784\u5efa\u6210 WebAssembly \u5b57\u8282\u7801\u6216\u672c\u673a\u4ee3\u7801\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd api/functions/image-grayscale/\ncargo build --release --target wasm32-wasip1\n")),(0,r.kt)("p",null,"\u5c06\u6784\u5efa\u51fa\u7ed3\u679c\u590d\u5236\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"api")," \u6587\u4ef6\u5939\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cp target/wasm32-wasip1/release/grayscale.wasm ../../\n")),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u5728\u6784\u5efa Docker \u955c\u50cf\u65f6\uff0c\u5c06\u6267\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"api/pre.sh"),"\u3002",(0,r.kt)("inlineCode",{parentName:"p"},"pre.sh")," \u5b89\u88c5 WasmEdge \u8fd0\u884c\u65f6\uff0c\u7136\u540e\u5c06\u6bcf\u4e2a WebAssembly \u5b57\u8282\u7801\u7a0b\u5e8f\u7f16\u8bd1\u6210\u672c\u5730 ",(0,r.kt)("inlineCode",{parentName:"p"},"so")," \u5e93\uff0c\u4ee5\u5b9e\u73b0\u66f4\u5feb\u7684\u6267\u884c\u3002")),(0,r.kt)("h3",{id:"\u521b\u5efa\u670d\u52a1\u811a\u672c\u4ee5\u52a0\u8f7d\u51fd\u6570"},"\u521b\u5efa\u670d\u52a1\u811a\u672c\u4ee5\u52a0\u8f7d\u51fd\u6570"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/blob/main/api/hello.js"},(0,r.kt)("inlineCode",{parentName:"a"},"api/hello.js"))," \u811a\u672c\u52a0\u8f7d WasmEdge \u8fd0\u884c\u65f6\uff0c\u5728 WasmEdge \u4e2d\u542f\u52a8\u7f16\u8bd1\u540e\u7684 WebAssembly \u7a0b\u5e8f\uff0c\u5e76\u901a\u8fc7 ",(0,r.kt)("inlineCode",{parentName:"p"},"STDIN")," \u4f20\u9012\u4e0a\u4f20\u7684\u56fe\u50cf\u6570\u636e\u3002\u8bf7\u6ce8\u610f\uff0c\u4e3a\u4e86\u5b9e\u73b0\u66f4\u597d\u7684\u6027\u80fd\uff0c",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/blob/main/api/hello.js"},(0,r.kt)("inlineCode",{parentName:"a"},"api/hello.js"))," \u8fd0\u884c\u7684\u7531 ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/blob/main/api/pre.sh"},(0,r.kt)("inlineCode",{parentName:"a"},"api/pre.sh"))," \u751f\u6210\u7684\u7f16\u8bd1\u540e\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"grayscale.so")," \u6587\u4ef6\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"const { spawn } = require('child_process');\nconst path = require('path');\n\nfunction _runWasm(reqBody) {\n  return new Promise((resolve) => {\n    const wasmedge = spawn(path.join(__dirname, 'wasmedge'), [\n      path.join(__dirname, 'grayscale.so'),\n    ]);\n\n    let d = [];\n    wasmedge.stdout.on('data', (data) => {\n      d.push(data);\n    });\n\n    wasmedge.on('close', (code) => {\n      let buf = Buffer.concat(d);\n      resolve(buf);\n    });\n\n    wasmedge.stdin.write(reqBody);\n    wasmedge.stdin.end('');\n  });\n}\n")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"hello.js")," \u4e2d\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"exports.handler")," \u90e8\u5206\u5bfc\u51fa\u4e86\u4e00\u4e2a\u5f02\u6b65\u51fd\u6570\u5904\u7406\u7a0b\u5e8f\uff0c\u7528\u4e8e\u5904\u7406\u6bcf\u6b21\u8c03\u7528\u65e0\u670d\u52a1\u5668\u51fd\u6570\u65f6\u7684\u4e0d\u540c\u4e8b\u4ef6\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u7b80\u5355\u5730\u901a\u8fc7\u8c03\u7528\u4e0a\u8ff0\u51fd\u6570\u5904\u7406\u56fe\u50cf\u5e76\u8fd4\u56de\u7ed3\u679c\uff0c\u4f46\u53ef\u4ee5\u6839\u636e\u4f60\u7684\u9700\u6c42\u5b9a\u4e49\u66f4\u590d\u6742\u7684\u4e8b\u4ef6\u5904\u7406\u884c\u4e3a\u3002\u6b64\u5916\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u8fd4\u56de\u4e00\u4e9b ",(0,r.kt)("inlineCode",{parentName:"p"},"Access-Control-Allow")," \u6807\u5934\u4ee5\u907f\u514d\u5728\u4ece\u6d4f\u89c8\u5668\u8c03\u7528\u65e0\u670d\u52a1\u5668\u51fd\u6570\u65f6\u51fa\u73b0 ",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS"},"\u8de8\u6e90\u8d44\u6e90\u5171\u4eab\uff08CORS\uff09")," \u9519\u8bef\u3002\u5982\u679c\u4f60\u5728\u590d\u5236\u6211\u4eec\u7684\u793a\u4f8b\u65f6\u9047\u5230 CORS \u9519\u8bef\uff0c\u53ef\u4ee5\u5728",(0,r.kt)("a",{parentName:"p",href:"https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS/Errors"},"\u8fd9\u91cc"),"\u4e86\u89e3\u66f4\u591a\u5173\u4e8e CORS \u9519\u8bef\u7684\u4fe1\u606f\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"exports.handler = async function (event, context) {\n  var typedArray = new Uint8Array(\n    event.body.match(/[\\da-f]{2}/gi).map(function (h) {\n      return parseInt(h, 16);\n    }),\n  );\n  let buf = await _runWasm(typedArray);\n  return {\n    statusCode: 200,\n    headers: {\n      'Access-Control-Allow-Headers':\n        'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token',\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods':\n        'DELETE, GET, HEAD, OPTIONS, PATCH, POST, PUT',\n    },\n    body: buf.toString('hex'),\n  };\n};\n")),(0,r.kt)("h3",{id:"\u6784\u5efa\u7528\u4e8e-lambda-\u90e8\u7f72\u7684-docker-\u955c\u50cf"},"\u6784\u5efa\u7528\u4e8e Lambda \u90e8\u7f72\u7684 Docker \u955c\u50cf"),(0,r.kt)("p",null,"\u73b0\u5728\u6211\u4eec\u62e5\u6709\u4e86 WebAssembly \u5b57\u8282\u7801\u51fd\u6570\u4ee5\u53ca\u52a0\u8f7d\u548c\u8fde\u63a5\u5230\u7f51\u7edc\u8bf7\u6c42\u7684\u811a\u672c\u3002\u4e3a\u4e86\u5c06\u5b83\u4eec\u90e8\u7f72\u4e3a AWS Lambda \u4e0a\u7684\u51fd\u6570\u670d\u52a1\uff0c\u4f60\u4ecd\u7136\u9700\u8981\u5c06\u6574\u4e2a\u5185\u5bb9\u6253\u5305\u6210\u4e00\u4e2a Docker \u955c\u50cf\u3002"),(0,r.kt)("p",null,"\u6211\u4eec\u4e0d\u4f1a\u8be6\u7ec6\u4ecb\u7ecd\u5982\u4f55\u6784\u5efa Docker \u955c\u50cf\u5e76\u5728 AWS Lambda \u4e0a\u90e8\u7f72\uff0c\u56e0\u4e3a\u5728",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/blob/tensorflow/README.md#deploy"},"\u5b58\u50a8\u5e93 README \u7684\u90e8\u7f72\u90e8\u5206"),"\u4e2d\u6709\u8be6\u7ec6\u7684\u6b65\u9aa4\u3002\u7136\u800c\uff0c\u6211\u4eec\u5c06\u4e3a\u4f60\u7a81\u51fa\u663e\u793a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/blob/tensorflow/api/Dockerfile"},(0,r.kt)("inlineCode",{parentName:"a"},"Dockerfile"))," \u4e2d\u7684\u4e00\u4e9b\u884c\uff0c\u4ee5\u907f\u514d\u4e00\u4e9b\u95ee\u9898\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-dockerfile"},'FROM public.ecr.aws/lambda/nodejs:14\n\n# Change directory to /var/task\nWORKDIR /var/task\n\nRUN yum update -y && yum install -y curl tar gzip\n\n# Bundle and pre-compile the wasm files\nCOPY *.wasm ./\nCOPY pre.sh ./\nRUN chmod +x pre.sh\nRUN ./pre.sh\n\n# Bundle the JS files\nCOPY *.js ./\n\nCMD [ "hello.handler" ]\n')),(0,r.kt)("p",null,"\u9996\u5148\uff0c\u6211\u4eec\u662f\u4ece ",(0,r.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/amazon/aws-lambda-nodejs"},"AWS Lambda \u7684 Node.js \u57fa\u7840\u955c\u50cf"),"\u6784\u5efa\u955c\u50cf\u3002\u4f7f\u7528 AWS Lambda \u57fa\u7840\u955c\u50cf\u7684\u4f18\u52bf\u5728\u4e8e\u5b83\u5305\u542b\u4e86",(0,r.kt)("a",{parentName:"p",href:"https://github.com/aws/aws-lambda-nodejs-runtime-interface-client"},"Lambda Runtime Interface Client (RIC)"),"\uff0c\u8fd9\u662f Lambda \u8fd0\u884c\u73af\u5883\u4e2d\u6240\u9700\u7684\u4f9d\u8d56\u3002Amazon Linux \u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"yum")," \u4f5c\u4e3a\u5305\u7ba1\u7406\u5668\u3002"),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"\u8fd9\u4e9b\u57fa\u7840\u955c\u50cf\u5305\u542b\u4e86 Amazon Linux Base \u64cd\u4f5c\u7cfb\u7edf\u3001\u7279\u5b9a\u8bed\u8a00\u7684\u8fd0\u884c\u65f6\u3001\u4f9d\u8d56\u9879\u548c Lambda Runtime Interface Client (RIC)\uff0c\u8be5\u5ba2\u6237\u7aef\u5b9e\u73b0\u4e86 Lambda ",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/lambda/latest/dg/runtimes-api.html"},"\u8fd0\u884c\u65f6 API"),"\u3002Lambda Runtime Interface Client \u5141\u8bb8\u4f60\u7684\u8fd0\u884c\u65f6\u63a5\u6536\u6765\u81ea Lambda \u670d\u52a1\u7684\u8bf7\u6c42\u5e76\u53d1\u9001\u8bf7\u6c42\u3002")),(0,r.kt)("p",null,"\u5176\u6b21\uff0c\u6211\u4eec\u9700\u8981\u5c06\u6211\u4eec\u7684\u51fd\u6570\u53ca\u5176\u6240\u6709\u4f9d\u8d56\u9879\u653e\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"/var/task")," \u76ee\u5f55\u4e2d\u3002\u5176\u4ed6\u6587\u4ef6\u5939\u4e2d\u7684\u6587\u4ef6\u5c06\u4e0d\u4f1a\u88abAWS Lambda\u6267\u884c\u3002"),(0,r.kt)("p",null,"\u7b2c\u4e09\uff0c\u6211\u4eec\u9700\u8981\u5b9a\u4e49\u542f\u52a8\u5bb9\u5668\u65f6\u7684\u9ed8\u8ba4\u547d\u4ee4\u3002",(0,r.kt)("inlineCode",{parentName:"p"},'CMD [ "hello.handler" ]')," \u8868\u793a\u5728\u8c03\u7528\u65e0\u670d\u52a1\u5668\u51fd\u6570\u65f6\uff0c\u6211\u4eec\u5c06\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"hello.js")," \u4e2d\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"handler")," \u51fd\u6570\u3002\u8bf7\u56de\u60f3\u6211\u4eec\u5728\u4e4b\u524d\u7684\u6b65\u9aa4\u4e2d\u901a\u8fc7 ",(0,r.kt)("inlineCode",{parentName:"p"},"exports.handler = ...")," \u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"hello.js")," \u4e2d\u5b9a\u4e49\u5e76\u5bfc\u51fa\u4e86\u5904\u7406\u7a0b\u5e8f\u51fd\u6570\u3002"),(0,r.kt)("h3",{id:"\u53ef\u9009\u672c\u5730\u6d4b\u8bd5-docker-\u955c\u50cf"},"\u53ef\u9009\uff1a\u672c\u5730\u6d4b\u8bd5 Docker \u955c\u50cf"),(0,r.kt)("p",null,"\u4ece AWS Lambda \u7684\u57fa\u7840\u955c\u50cf\u6784\u5efa\u7684 Docker \u955c\u50cf\u53ef\u4ee5\u6309\u7167",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/lambda/latest/dg/images-test.html"},"\u6b64\u6307\u5357"),"\u5728\u672c\u5730\u8fdb\u884c\u6d4b\u8bd5\u3002\u672c\u5730\u6d4b\u8bd5\u9700\u8981 ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/aws/aws-lambda-runtime-interface-emulator"},"AWS Lambda Runtime Interface Emulator (RIE)"),"\uff0c\u5b83\u5df2\u7ecf\u5b89\u88c5\u5728\u6240\u6709 AWS Lambda \u7684\u57fa\u7840\u955c\u50cf\u4e2d\u3002\u8981\u6d4b\u8bd5\u4f60\u7684\u955c\u50cf\uff0c\u9996\u5148\u8fd0\u884c\u4ee5\u4e0b\u547d\u4ee4\u542f\u52a8 Docker \u5bb9\u5668\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"docker run -p 9000:8080  myfunction:latest\n")),(0,r.kt)("p",null,"\u6b64\u547d\u4ee4\u5728\u672c\u5730\u673a\u5668\u4e0a\u8bbe\u7f6e\u4e00\u4e2a\u51fd\u6570\u63a5\u53e3\uff0c\u5730\u5740\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"http://localhost:9000/2015-03-31/functions/function/invocations"),"\u3002"),(0,r.kt)("p",null,"\u7136\u540e\uff0c\u4ece\u53e6\u4e00\u4e2a\u7ec8\u7aef\u7a97\u53e3\u8fd0\u884c\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"curl -XPOST \"http://localhost:9000/2015-03-31/functions/function/invocations\" -d '{}'\n")),(0,r.kt)("p",null,"\u4f60\u5e94\u8be5\u5728\u7ec8\u7aef\u4e2d\u83b7\u5f97\u4f60\u671f\u671b\u7684\u8f93\u51fa\u3002"),(0,r.kt)("p",null,"\u5982\u679c\u4f60\u4e0d\u60f3\u4f7f\u7528 AWS Lambda \u7684\u57fa\u7840\u955c\u50cf\uff0c\u4f60\u4e5f\u53ef\u4ee5\u4f7f\u7528\u81ea\u5df1\u7684\u57fa\u7840\u955c\u50cf\uff0c\u5e76\u5728\u6784\u5efa Docker \u955c\u50cf\u65f6\u5b89\u88c5 RIC \u548c/\u6216 RIE\u3002\u53ea\u9700\u6309\u7167",(0,r.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/lambda/latest/dg/images-create.html"},"\u6b64\u6307\u5357"),"\u4e2d\u7684 ",(0,r.kt)("strong",{parentName:"p"},"Create an image from an alternative base image")," \u90e8\u5206\u8fdb\u884c\u64cd\u4f5c\u3002"),(0,r.kt)("p",null,"\u51c6\u5907\u5c31\u7eea\uff01\u5728\u6784\u5efa\u5b8c Docker \u955c\u50cf\u540e\uff0c\u53ef\u4ee5\u53c2\u8003\u5b58\u50a8\u5e93 ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/blob/tensorflow/README.md#deploy"},"README"),"\u4e2d\u7b80\u8ff0\u7684\u6b65\u9aa4\u5c06\u5176\u90e8\u7f72\u5230 AWS Lambda\u3002\u7136\u540e\u4f60\u7684\u65e0\u670d\u52a1\u5668\u51fd\u6570\u5c31\u53ef\u4ee5\u5f00\u59cb\u5de5\u4f5c\u4e86\uff01"),(0,r.kt)("h2",{id:"\u793a\u4f8b-2ai-\u63a8\u7406"},"\u793a\u4f8b 2\uff1aAI \u63a8\u7406"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/tree/tensorflow"},"\u7b2c\u4e8c\u4e2a\u6f14\u793a")," \u5e94\u7528\u5141\u8bb8\u7528\u6237\u4e0a\u4f20\u56fe\u50cf\uff0c\u7136\u540e\u8c03\u7528\u4e00\u4e2a\u65e0\u670d\u52a1\u5668\u51fd\u6570\u5bf9\u56fe\u50cf\u7684\u4e3b\u8981\u5bf9\u8c61\u8fdb\u884c\u5206\u7c7b\u3002"),(0,r.kt)("p",null,"\u5b83\u4f4d\u4e8e\u4e0e\u4e4b\u524d\u793a\u4f8b\u76f8\u540c\u7684 ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/tree/tensorflow"},"GitHub \u5b58\u50a8\u5e93"),"\uff0c\u4f46\u5728 ",(0,r.kt)("inlineCode",{parentName:"p"},"tensorflow")," \u5206\u652f\u4e2d\u3002\u7528\u4e8e\u56fe\u50cf\u5206\u7c7b\u7684\u540e\u7aef\u65e0\u670d\u52a1\u5668\u51fd\u6570\u4f4d\u4e8e ",(0,r.kt)("inlineCode",{parentName:"p"},"tensorflow")," \u5206\u652f\u4e2d\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"api/functions/image-classification")," \u6587\u4ef6\u5939\u4e2d\u3002",(0,r.kt)("inlineCode",{parentName:"p"},"src/main.rs")," \u6587\u4ef6\u5305\u542b\u4e86 Rust \u7a0b\u5e8f\u7684\u6e90\u4ee3\u7801\u3002Rust \u7a0b\u5e8f\u4ece ",(0,r.kt)("inlineCode",{parentName:"p"},"STDIN")," \u8bfb\u53d6\u56fe\u50cf\u6570\u636e\uff0c\u7136\u540e\u5c06\u6587\u672c\u8f93\u51fa\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"STDOUT"),"\u3002\u5b83\u5229\u7528\u4e86 WasmEdge Tensorflow API \u6765\u8fd0\u884cAI\u63a8\u7406\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'pub fn main() {\n  // Step 1: Load the TFLite model\n  let model_data: &[u8] = include_bytes!("models/mobilenet_v1_1.0_224/mobilenet_v1_1.0_224_quant.tflite");\n  let labels = include_str!("models/mobilenet_v1_1.0_224/labels_mobilenet_quant_v1_224.txt");\n\n  // Step 2: Read image from STDIN\n  let mut buf = Vec::new();\n  io::stdin().read_to_end(&mut buf).unwrap();\n\n  // Step 3: Resize the input image for the tensorflow model\n  let flat_img = wasmedge_tensorflow_interface::load_jpg_image_to_rgb8(&buf, 224, 224);\n\n  // Step 4: AI inference\n  let mut session = wasmedge_tensorflow_interface::Session::new(&model_data, wasmedge_tensorflow_interface::ModelType::TensorFlowLite);\n  session.add_input("input", &flat_img, &[1, 224, 224, 3])\n         .run();\n  let res_vec: Vec<u8> = session.get_output("MobilenetV1/Predictions/Reshape_1");\n\n  // Step 5: Find the food label that responds to the highest probability in res_vec\n  // ... ...\n  let mut label_lines = labels.lines();\n  for _i in 0..max_index {\n    label_lines.next();\n  }\n\n  // Step 6: Generate the output text\n  let class_name = label_lines.next().unwrap().to_string();\n  if max_value > 50 {\n    println!("It {} a <a href=\'https://www.google.com/search?q={}\'>{}</a> in the picture", confidence.to_string(), class_name, class_name);\n  } else {\n    println!("It does not appears to be any food item in the picture.");\n  }\n}\n')),(0,r.kt)("p",null,"\u4f60\u53ef\u4ee5\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"cargo")," \u5de5\u5177\u5c06 Rust \u7a0b\u5e8f\u6784\u5efa\u6210 WebAssembly \u5b57\u8282\u7801\u6216\u672c\u673a\u4ee3\u7801\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cd api/functions/image-classification/\ncargo build --release --target wasm32-wasip1\n")),(0,r.kt)("p",null,"\u5c06\u6784\u5efa\u4ea7\u7269\u590d\u5236\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"api")," \u6587\u4ef6\u5939\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"cp target/wasm32-wasip1/release/classify.wasm ../../\n")),(0,r.kt)("p",null,"\u540c\u6837\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"api/pre.sh")," \u811a\u672c\u5728\u6b64\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5b89\u88c5\u4e86 WasmEdge \u8fd0\u884c\u65f6\u53ca\u5176 TensorFlow \u4f9d\u8d56\u9879\u3002\u5b83\u8fd8\u5728\u90e8\u7f72\u65f6\u5c06 ",(0,r.kt)("inlineCode",{parentName:"p"},"classify.wasm")," \u5b57\u8282\u7801\u7a0b\u5e8f\u7f16\u8bd1\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"classify.so")," \u672c\u673a\u5171\u4eab\u5e93\u3002"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/blob/tensorflow/api/hello.js"},(0,r.kt)("inlineCode",{parentName:"a"},"api/hello.js"))," \u811a\u672c\u52a0\u8f7d WasmEdge \u8fd0\u884c\u65f6\uff0c\u5728 WasmEdge \u4e2d\u542f\u52a8\u7f16\u8bd1\u540e\u7684 WebAssembly \u7a0b\u5e8f\uff0c\u5e76\u901a\u8fc7 ",(0,r.kt)("inlineCode",{parentName:"p"},"STDIN")," \u4f20\u9012\u4e0a\u4f20\u7684\u56fe\u50cf\u6570\u636e\u3002\u8bf7\u6ce8\u610f\uff0c",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/blob/tensorflow/api/hello.js"},(0,r.kt)("inlineCode",{parentName:"a"},"api/hello.js"))," \u8fd0\u884c\u7531 ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/blob/tensorflow/api/pre.sh"},(0,r.kt)("inlineCode",{parentName:"a"},"api/pre.sh"))," \u751f\u6210\u7684\u7f16\u8bd1\u540e\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"classify.so")," \u6587\u4ef6\uff0c\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u6027\u80fd\u3002\u5904\u7406\u51fd\u6570\u7c7b\u4f3c\u4e8e\u6211\u4eec\u4e4b\u524d\u7684\u793a\u4f8b\uff0c\u5728\u6b64\u7701\u7565\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-javascript"},"const { spawn } = require('child_process');\nconst path = require('path');\n\nfunction _runWasm(reqBody) {\n  return new Promise(resolve => {\n    const wasmedge = spawn(\n      path.join(__dirname, 'wasmedge-tensorflow-lite'),\n      [path.join(__dirname, 'classify.so')],\n      {env: {'LD_LIBRARY_PATH': __dirname}}\n    );\n\n    let d = [];\n    wasmedge.stdout.on('data', (data) => {\n      d.push(data);\n    });\n\n    wasmedge.on('close', (code) => {\n      resolve(d.join(''));\n    });\n\n    wasmedge.stdin.write(reqBody);\n    wasmedge.stdin.end('');\n  });\n}\n\nexports.handler = ... // _runWasm(reqBody) is called in the handler\n")),(0,r.kt)("p",null,"\u4f60\u53ef\u4ee5\u6309\u7167\u4e4b\u524d\u7684\u793a\u4f8b\u4e2d\u6982\u8ff0\u7684\u65b9\u5f0f\u6784\u5efa\u4f60\u7684 Docker \u955c\u50cf\u5e76\u90e8\u7f72\u51fd\u6570\u3002\u73b0\u5728\u4f60\u5df2\u7ecf\u521b\u5efa\u4e86\u4e00\u4e2a\u7528\u4e8e\u4e3b\u9898\u5206\u7c7b\u7684 Web \u5e94\u7528\uff01"),(0,r.kt)("p",null,"\u63a5\u4e0b\u6765\uff0c\u8f6e\u5230\u4f60\u4f7f\u7528 ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/second-state/aws-lambda-wasm-runtime/tree/main"},"aws-lambda-wasm-runtime \u5b58\u50a8\u5e93")," \u4f5c\u4e3a\u6a21\u677f\uff0c\u5728 AWS Lambda \u4e0a\u5f00\u53d1 Rust \u65e0\u670d\u52a1\u5668\u51fd\u6570\u4e86\u3002\u671f\u5f85\u7740\u4f60\u7684\u51fa\u8272\u5de5\u4f5c\u3002"))}u.isMDXComponent=!0}}]);